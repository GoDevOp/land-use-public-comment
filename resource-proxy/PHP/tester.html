<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Proxy Load Test Tool</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.7/js/dojo/dijit/themes/nihilo/nihilo.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.7/js/esri/css/esri.css">
    <style>
      html, body, #map {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #FFF;
        overflow: hidden;
        font-family: "Trebuchet MS";
      }
    </style>
    <script src="http://js.arcgis.com/3.6/"></script>
    <script>


require(["dojo/parser", "dojo/request/script", "dijit/form/Button", "dijit/form/TextBox", "dojo/io/script", "dojo/request/xhr", "dojo/dom", "dojo/dom-construct", "dojo/json", "dojo/on", "dojo/domReady!"], function (parser, script, Button, TextBox, ioScript, xhr, dom, domConst, JSON, on) {

	var counreplay= 0;

	var x = 0;

	var disabled = false;

	var b = 0;

	var counter;

	var myButton = new Button({
        label: "Test Start",
		id: "startButton"
    }, "start-button");


	var urlInput = new TextBox({style:"width: 75em;", value: "http://localhost/sproxy/dev/proxy.php?http://sampleserver6.arcgisonline.com/arcgis/rest/info?f=pjson"}, "url-input");

	var editCyclesInput = new TextBox({value:2}, "edit-cycles");

	var timeIntervalInput = new TextBox({value: 1.01}, "time-interval");

	on(dom.byId("startButton"), "click", function () {

		var cycles = dom.byId("edit-cycles").value;

		var interval = dom.byId("time-interval").value * 1000;

		if(cycles == 0 || interval == 0)
		{
			alert("You need to set number of requests and time interval.");

			return;
		}

		var x = 0;

		if(disabled == false) {

			disabled = true;

			function runTestInterval() {

				replay();

				if (x++ < cycles - 1) {

					setTimeout(runTestInterval, interval);

				}else{

					disabled = false;
				}
			}

			runTestInterval();

		}else{

			alert("Test in process... cannot complete");
		}

    });

	function replay() {

		b++;

		console.log("b" + b);

		var d = new Date();

		var sec = d.getSeconds();

		var proxyurl = dom.byId("url-input").value;

		var xhrArgs = {
			    url: proxyurl,
			    handleAs: "text",
			    load: function(data){

			    	domConst.place("<p><b>response " + b + ": </b><pre>" + data + "</pre></p>", "output");

				},
				error: function(error){

				   domConst.place("<p><b>response " + b + ": </b><code>" + JSON.stringify(error) + "</code></p>", "output");
				}
			  }

			  var deferred = dojo.xhrGet(xhrArgs);

		counter++;

		return;
	}

	function callback(d)
	{
		console.log(d);
	}

});

</script>

  <body class="nihilo" style="padding:12px;">

  <button id="start-button" type="button"></button>

  <br/>

  <br/>

  <label style="margin-left:6px; margin-right:6px;" > Url to proxy</label><input style="margin-left:6px; margin-right:6px; width:50em;" id="url-input" />

  <br/>

  <br/>



  <small>(User/Password Test) http://geoenrich.arcgis.com/arcgis/rest/services/World/MapServer/exts/BAServer/Geoenrichment/Reports/United%20States?f=pjson</small>

  <br/>

  <small>(OAuth Test) http://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World?f=pjson</small>

  <br/>

  <small>(matchAll False) http://services.arcgisonline.com/ArcGIS/rest/services?f=pjson</small>

  <br/>

  <small>(basic) http://sampleserver6.arcgisonline.com/arcgis/rest/info?f=pjson</small>

  <br/>

  <br/>

  <label style="margin-left:6px; margin-right:6px;" > # of requests</label><input style="margin-left:6px; margin-right:6px;" id="edit-cycles" />

  <span style="margin-left:6px; margin-right:6px;" ><small>* uses dojo.xhrGet</small></span>

  <label style="margin-left:6px; margin-right:6px;" > time interval between requests </label><input style="margin-left:6px; margin-right:6px;" id="time-interval" />

  <span style="margin-left:6px; margin-right:6px;" ><small>*time unit is seconds </small></span>

  <h1>Proxy Response:</h1>

  <div id="output" style="overflow-y: scroll; height:80%; width:90%; padding-left:24px; padding-right:24px;"></div>

  </body>

</html>
